<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook OAuth Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #1877f2;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        .test-button:hover {
            background: #166fe5;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #1877f2;
            border-bottom: 2px solid #1877f2;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Facebook OAuth Flow Test</h1>
    
    <div class="test-container">
        <h2>Step 1: Test OAuth Redirect</h2>
        <p>This will test if the Facebook OAuth endpoint redirects to Facebook authorization page.</p>
        <button class="test-button" onclick="testOAuthRedirect()">Test Facebook OAuth Redirect</button>
        <div id="redirect-status"></div>
    </div>

    <div class="test-container">
        <h2>Step 2: Test Complete OAuth Flow</h2>
        <p>This will start the complete OAuth flow - you'll be redirected to Facebook to authorize the app.</p>
        <button class="test-button" onclick="startOAuthFlow()">Start Facebook Login Flow</button>
        <div id="oauth-status"></div>
    </div>

    <div class="test-container">
        <h2>Step 3: Test App Configuration</h2>
        <p>This will verify the Facebook app configuration and credentials.</p>
        <button class="test-button" onclick="testAppConfig()">Test App Configuration</button>
        <div id="config-status"></div>
    </div>

    <div class="test-container">
        <h2>Debug Information</h2>
        <button class="test-button" onclick="showDebugInfo()">Show Debug Information</button>
        <div id="debug-log" class="log" style="display: none;"></div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        
        async function testOAuthRedirect() {
            const statusDiv = document.getElementById('redirect-status');
            statusDiv.innerHTML = '<div class="info">Testing OAuth redirect...</div>';
            
            try {
                const response = await fetch('/api/auth/facebook', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                if (response.status === 302) {
                    const location = response.headers.get('location');
                    if (location && location.includes('facebook.com')) {
                        statusDiv.innerHTML = `
                            <div class="success">✅ OAuth redirect working correctly!</div>
                            <div class="info">Redirects to: ${location.substring(0, 100)}...</div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="error">❌ OAuth redirects but not to Facebook</div>
                            <div class="info">Redirects to: ${location}</div>
                        `;
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">❌ OAuth endpoint returned status: ${response.status}</div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">❌ Error testing OAuth redirect: ${error.message}</div>
                `;
            }
        }
        
        function startOAuthFlow() {
            const statusDiv = document.getElementById('oauth-status');
            statusDiv.innerHTML = '<div class="info">Redirecting to Facebook OAuth...</div>';
            
            // Redirect to Facebook OAuth endpoint
            window.location.href = '/api/auth/facebook';
        }
        
        async function testAppConfig() {
            const statusDiv = document.getElementById('config-status');
            statusDiv.innerHTML = '<div class="info">Testing app configuration...</div>';
            
            try {
                const response = await fetch('/api/facebook/debug');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="success">✅ App configuration test successful!</div>
                        <div class="info">App ID: ${data.appId}</div>
                        <div class="info">App Status: ${data.status}</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">❌ App configuration test failed</div>
                        <div class="info">Error: ${data.error || 'Unknown error'}</div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">❌ Error testing app configuration: ${error.message}</div>
                `;
            }
        }
        
        function showDebugInfo() {
            const debugLog = document.getElementById('debug-log');
            debugLog.style.display = debugLog.style.display === 'none' ? 'block' : 'none';
            
            if (debugLog.style.display === 'block') {
                debugLog.innerHTML = `
App Information:
- App ID: 1420319199160179
- App Name: MyLinked App
- Base URL: ${baseUrl}
- OAuth Endpoint: ${baseUrl}/api/auth/facebook
- Callback URL: ${baseUrl}/api/auth/facebook/callback

OAuth Flow:
1. User clicks "Continue with Facebook"
2. Redirect to /api/auth/facebook
3. Server redirects to Facebook authorization
4. User authorizes app on Facebook
5. Facebook redirects to callback with authorization code
6. Server exchanges code for access token
7. Server retrieves user profile from Facebook
8. Server creates/updates user account
9. User is logged in and redirected to dashboard

Test Results:
- Environment variables: ${navigator.userAgent.includes('Chrome') ? 'Check server logs' : 'Browser dependent'}
- Current URL: ${window.location.href}
- Session: ${document.cookie.includes('connect.sid') ? 'Session cookie present' : 'No session cookie'}
                `;
            }
        }
        
        // Check if we're returning from Facebook OAuth
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code')) {
            document.getElementById('oauth-status').innerHTML = `
                <div class="success">✅ Returned from Facebook with authorization code!</div>
                <div class="info">Authorization code: ${urlParams.get('code').substring(0, 20)}...</div>
                <div class="info">The server should now exchange this code for an access token.</div>
            `;
        } else if (urlParams.has('error')) {
            document.getElementById('oauth-status').innerHTML = `
                <div class="error">❌ OAuth flow returned with error</div>
                <div class="info">Error: ${urlParams.get('error')}</div>
                <div class="info">Description: ${urlParams.get('error_description') || 'No description'}</div>
            `;
        }
    </script>
</body>
</html>